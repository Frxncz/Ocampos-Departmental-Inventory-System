<script>
  const LOW_STOCK_THRESHOLD = 10;

  let currentDept = "";
  let items = [];
  let editOriginalCode = "";

  const $ = (id) => document.getElementById(id);

  function show(el, isShown){ el.style.display = isShown ? "block" : "none"; }
  function showFlex(el, isShown){ el.style.display = isShown ? "flex" : "none"; }

  function statusFromQty(q){ return Number(q) <= LOW_STOCK_THRESHOLD ? "LOW" : "OK"; }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // ---- LOAD DEPARTMENTS (this is what creates the buttons) ----
  function loadDepartments(){
    $("deptHint").textContent = "Loading departments...";

    google.script.run
      .withSuccessHandler((depts) => {
        renderDepartments(depts || []);
      })
      .withFailureHandler((err) => {
        // THIS will tell you the real reason buttons are not showing
        alert("Failed to load departments: " + (err?.message || err));
        $("deptHint").textContent = "Failed to load departments. Check sheet name and permissions.";
      })
      .getDepartments();
  }

  function renderDepartments(depts){
    const grid = $("deptGrid");
    grid.innerHTML = "";

    if (!depts.length) {
      $("deptHint").textContent =
        "No departments found. Put department names in the DEPARTMENTS sheet column A starting at A2.";
      return;
    }

    $("deptHint").textContent = "";

    depts.forEach(d => {
      const b = document.createElement("button");
      b.className = "deptBtn";
      b.textContent = d;
      b.addEventListener("click", () => openDept(d));
      grid.appendChild(b);
    });
  }

  function openDept(dept){
    currentDept = dept;
    $("deptTitle").textContent = dept;

    show($("viewDepartments"), false);
    show($("viewInventory"), true);

    refreshItems();
  }

  function goBack(){
    show($("viewInventory"), false);
    show($("viewDepartments"), true);
    currentDept = "";
    items = [];
    $("invBody").innerHTML = "";
  }

  function refreshItems(){
    if(!currentDept) return;

    google.script.run
      .withSuccessHandler((res) => {
        items = res || [];
        renderItems();
      })
      .withFailureHandler(err => alert("Failed to load items: " + (err?.message || err)))
      .getDepartmentItems(currentDept);
  }

  function renderItems(){
    const body = $("invBody");
    body.innerHTML = "";

    items.forEach(it => {
      const tr = document.createElement("tr");
      const stat = statusFromQty(it.stock);
      if (stat === "LOW") tr.classList.add("low");

      const img = (it.image && String(it.image).trim())
        ? `<img src="${escapeHtml(it.image)}" onerror="this.src='https://via.placeholder.com/50'">`
        : `<img src="https://via.placeholder.com/50">`;

      tr.innerHTML = `
        <td>${escapeHtml(it.code)}</td>
        <td>${escapeHtml(it.name)}</td>
        <td>${escapeHtml(it.category)}</td>
        <td>${Number(it.stock)}</td>
        <td>${escapeHtml(it.unit || "")}</td>
        <td><b>${stat}</b></td>
        <td>${img}</td>
        <td>
          <button class="actBtn editBtn" data-edit="${escapeHtml(it.code)}">Edit</button>
          <button class="actBtn delBtn" data-del="${escapeHtml(it.code)}">Delete</button>
        </td>
      `;
      body.appendChild(tr);
    });

    body.onclick = (e) => {
      const editCode = e.target?.dataset?.edit;
      const delCode  = e.target?.dataset?.del;
      if (editCode) openEdit(editCode);
      if (delCode) del(delCode);
    };
  }

  // EDIT
  function openEdit(code){
    const it = items.find(x => x.code === code);
    if(!it) return;
    editOriginalCode = it.code;

    $("e_code").value = it.code || "";
    $("e_name").value = it.name || "";
    $("e_category").value = it.category || "";
    $("e_qty").value = it.stock ?? 0;
    $("e_unit").value = it.unit || "";
    $("e_image").value = it.image || "";

    showFlex($("editOverlay"), true);
  }
  function closeEdit(){ showFlex($("editOverlay"), false); }
  function removeImageEdit(){ $("e_image").value = ""; }

  function saveEdit(){
    const payload = {
      originalCode: editOriginalCode,
      code: $("e_code").value.trim(),
      name: $("e_name").value.trim(),
      category: $("e_category").value.trim(),
      stock: Number($("e_qty").value || 0),
      unit: $("e_unit").value.trim(),
      image: $("e_image").value.trim(),
      department: currentDept
    };

    google.script.run
      .withSuccessHandler(() => { closeEdit(); refreshItems(); })
      .withFailureHandler(err => alert(err?.message || err))
      .updateItem(payload);
  }

  // DELETE
  function del(code){
    if(!confirm("Delete this item?")) return;

    google.script.run
      .withSuccessHandler(() => refreshItems())
      .withFailureHandler(err => alert(err?.message || err))
      .deleteItem(code);
  }

  // ADD
  function openAdd(){
    $("a_name").value = "";
    $("a_category").value = "";
    $("a_qty").value = 0;
    $("a_image").value = "";
    showFlex($("addOverlay"), true);
  }
  function closeAdd(){ showFlex($("addOverlay"), false); }

  function saveAdd(){
    const payload = {
      name: $("a_name").value.trim(),
      category: $("a_category").value.trim(),
      department: currentDept,
      stock: Number($("a_qty").value || 0),
      image: $("a_image").value.trim()
    };

    google.script.run
      .withSuccessHandler((res) => {
        closeAdd();
        refreshItems();
        // optional: show the generated code
        if (res?.code) alert("Item added! Generated Code: " + res.code);
      })
      .withFailureHandler(err => alert(err?.message || err))
      .addItem(payload);
  }


  // Wire up
  document.addEventListener("DOMContentLoaded", () => {
    $("btnAdd").addEventListener("click", openAdd);
    $("btnBack").addEventListener("click", goBack);

    $("btnEditCancel").addEventListener("click", closeEdit);
    $("btnEditRemoveImg").addEventListener("click", removeImageEdit);
    $("btnEditSave").addEventListener("click", saveEdit);

    $("btnAddCancel").addEventListener("click", closeAdd);
    $("btnAddSave").addEventListener("click", saveAdd);

    loadDepartments();
  });
</script>
